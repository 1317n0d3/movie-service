(()=>{"use strict";const e=document.querySelector(".wrap"),t=class{constructor(e,t,i,n,s){this.filmIndex=e,this.name=t,this.profession=i,this.text=n,this.filmRating=s}renderComment(e){e.innerHTML+=`\n      <div class="film-comment" id="${this.filmIndex+this.name}">\n        <span class="user-comment-info">${this.name} - ${this.profession} - ${this.filmRating}</span>\n        <span class="user-comment-text" style="display: block;">${this.text}</span>\n      </div>\n    `}},i=new class{constructor(i){this.filmList=new class{constructor(){this.filmList=[],this.loadFilmList()}addFilm(e){this.filmList.push(this.createFilm(e))}createFilm(i){let{id:n,title:s,country:o,genre:r,director:l,filmScript:a,producer:c,operator:m,composer:u,budget:d,worldFees:h,ageRating:p,duration:f,releaseDate:g,poster:v}=i;return new class{constructor(e,t,i,n,s,o,r,l,a,c,m,u,d,h,p){this.id=e,this.title=t,this.country=i,this.genre=n,this.director=s,this.filmScript=o,this.producer=r,this.operator=l,this.composer=a,this.budget=c,this.worldFees=m,this.ageRating=u,this.duration=d,this.releaseDate=h,this.poster=p,this.comments=this.loadComments()}render(){e.innerHTML+=`\n      <div class="wrap__item" data-index="${this.id}">\n        <div class="wrap__item__context" id="contextMenu">\n          <button id="btnViewFilm" data-action="view" data-index="${this.id}">\n            <img src="../../assets/icons/view.svg" alt="icon: view film">\n          </button>\n          <button id="btnDeleteFilm" data-action="delete" data-index="${this.id}">\n            <img src="../../assets/icons/trash.svg" alt="icon: delete film">\n          </button>\n        </div>\n        <div class="wrap__item__content">\n          <img src="${this.poster}" alt="image: ${this.title}">\n          <span>${this.title}</span>\n        </div>\n      </div>\n    `}addEventOnFilmInfo(){const e=document.querySelector("#addComment");e&&e.addEventListener("click",(()=>{this.getNewComment(),console.log("add event")}))}getNewComment(){const e=this.id,i=JSON.parse(localStorage.getItem("user")).inputLogin,n=JSON.parse(localStorage.getItem("user")).inputProfession,s=document.querySelector("#commentText").value,o=document.querySelector("#filmRating").value;this.comments.push(new t(e,i,n,s,o)),this.saveComments(),console.log("push comment"),this.renderComments()}loadComments(){const e=[];return localStorage.getItem(this.id)&&JSON.parse(localStorage.getItem(this.id)).forEach((i=>{const{filmIndex:n,name:s,profession:o,text:r,filmRating:l}=i;e.push(new t(n,s,o,r,l))})),e}saveComments(){localStorage.setItem(this.id,JSON.stringify(this.comments))}renderComments(){const e=document.querySelector("#filmComments");console.log("render comments"),console.log(this.comments),e.innerHTML="",this.comments.forEach((t=>{t.renderComment(e),console.log(t)}))}renderFilmInfo(e){const t=new Date(this.releaseDate);e.innerHTML=`\n      <div class="film-info__main">\n        <div class="film-info__main__description">\n          <img src="${this.poster}" alt="image: ${this.title}">\n          <p>Название: ${this.title}</p>\n          <p>Страна: ${this.country.join(", ")}</p>\n          <p>Жанр: ${this.genre.join(", ")}</p>\n          <p>Режиссер: ${this.director}</p>\n          <p>Продюсер: ${this.producer}</p>\n          <p>Оператор: ${this.operator}</p>\n          <p>Композитор: ${this.composer}</p>\n          <p>Бюджет: ${this.budget}</p>\n          <p>Мировые сборы: ${this.worldFees}</p>\n          <p>Возрастной рейтинг: ${this.ageRating}</p>\n          <p>Длительность: ${this.duration}</p>\n          <p>Премьера: ${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()}</p>\n        </div>\n        <div class="film-info__main__title">\n          <h2>${this.title}</h2>\n          <p>${this.filmScript}</p>\n          <iframe width="560" height="315" src="https://www.youtube.com/embed/-V0ARqmnzSk" title="YouTube video player"\n            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"\n            allowfullscreen></iframe>\n          <div class="film-info__comments">\n            <form class="film-info__comments__form">\n              <div class="comment-text">\n                <input type="text" class="comment-text" id="commentText" placeholder="Отзыв">\n                <input type="button" id="addComment" value="Оставить отзыв">\n              </div>\n              <div class="comment-rating">\n                <input type="range" id="filmRating" list="tickmarks" min="0" max="10" step="1" value="7">\n                <datalist id="tickmarks">\n                  <option value="0" label="0"></option>\n                  <option value="1"></option>\n                  <option value="2"></option>\n                  <option value="3"></option>\n                  <option value="4"></option>\n                  <option value="5" label="5"></option>\n                  <option value="6"></option>\n                  <option value="7"></option>\n                  <option value="8"></option>\n                  <option value="9"></option>\n                  <option value="10" label="10"></option>\n                </datalist>\n              </div>\n            </form>\n            <h2>Комментарии</h2>\n            <div class="film-comments" id="filmComments">\n            </div>\n          </div>\n        </div>\n      </div>\n    `,this.addEventOnFilmInfo(),this.renderComments()}}(n,s,o,r,l,a,c,m,u,d,h,p,f,g,v)}deleteFilm(e){this.filmList=this.filmList.filter((t=>t.id!==e))}loadFilmList(){const e=JSON.parse(localStorage.getItem("films"));e&&e.forEach((e=>{this.filmList.push(this.createFilm(e))}))}saveFilmList(){localStorage.setItem("films",JSON.stringify(this.filmList))}generateItemId(){return this.filmList.length>0?this.filmList[this.filmList.length-1].id+1:this.filmList.length}getFilmList(){return this.filmList}renderFilmInfo(e,t){this.filmList.filter((t=>t.id===e))[0].renderFilmInfo(t)}render(){this.saveFilmList(),e.innerHTML="",this.filmList.forEach((e=>{e.render()}))}renderWithoutSaving(){e.innerHTML="",this.filmList.forEach((e=>{e.render()}))}},this.filter=new class{constructor(){this.countries=[],this.genres=[]}updateCountries(e){this.countries=[],e.forEach((e=>{e.country.forEach((e=>{-1===this.countries.indexOf(e)&&this.countries.push(e)}))}));const t=document.querySelector("#filterCountry");t.innerHTML='<option value="default">Страна</option>',this.countries.forEach((e=>{t.innerHTML+=`<option value="${e}">${e}</option>`}))}updateGenres(e){this.genres=[],e.forEach((e=>{e.genre.forEach((e=>{-1===this.genres.indexOf(e)&&this.genres.push(e)}))}));const t=document.querySelector("#filterGenre");t.innerHTML='<option value="default">Жанр</option>',this.genres.forEach((e=>{t.innerHTML+=`<option value="${e}">${e}</option>`}))}updateFilterData(e){this.updateCountries(e.getFilmList()),this.updateGenres(e.getFilmList())}sortByCountry(t,i){if("default"===i)return t.renderWithoutSaving();const n=t.getFilmList().filter((e=>-1!==e.country.indexOf(i)));e.innerHTML="",n.forEach((e=>{e.render()}))}sortByGenre(t,i){if("default"===i)return t.renderWithoutSaving();const n=t.getFilmList().filter((e=>-1!==e.genre.indexOf(i)));e.innerHTML="",n.forEach((e=>{e.render()}))}sortByNewest(t,i){let n=[];if("default"===i)return t.renderWithoutSaving();"newest"===i?n=t.getFilmList().sort(((e,t)=>t.releaseDate-e.releaseDate)):"oldest"===i&&(n=t.getFilmList().sort(((e,t)=>e.releaseDate-t.releaseDate))),e.innerHTML="",n.forEach((e=>{e.render()}))}},this.user=localStorage.getItem("user")?JSON.parse(localStorage.getItem("user")):{},this.wrap=i,i.onclick=this.onClick.bind(this)}view(e){const t=document.querySelector(".film-info");this.filmList.renderFilmInfo(+e,t),t.style.display="block"}delete(e){this.filmList.deleteFilm(+e),this.render()}onClick(){let e=event.target.parentNode.dataset.action;const t=event.target.parentNode.dataset.index;e&&this[e](t)}addFilm(){this.filmList.addFilm(this.getNewFilmData()),this.render()}getNewFilmData(){const e=document.querySelector("#title"),t=document.querySelector("#director"),i=document.querySelector("#filmScript"),n=document.querySelector("#country"),s=document.querySelector("#genre"),o=document.querySelector("#producer"),r=document.querySelector("#operator"),l=document.querySelector("#composer"),a=document.querySelector("#budget"),c=document.querySelector("#worldFees"),m=document.querySelector("#ageRating"),u=document.querySelector("#duration"),d=document.querySelector("#releaseDate"),h=document.querySelector("#poster"),p={id:this.filmList.generateItemId(),title:e.value,country:[],genre:[],director:t.value,filmScript:i.value,producer:o.value,operator:r.value,composer:l.value,budget:a.value,worldFees:c.value,ageRating:m.value,duration:u.value,releaseDate:d.valueAsNumber,poster:""===h.value?"https://mimicosmetic.ru/wp-content/uploads/woocommerce-placeholder.png":document.querySelector("#poster").value};return n.value.split(",").forEach((e=>{p.country.push(e.trim().toLowerCase())})),s.value.split(",").forEach((e=>{p.genre.push(e.trim().toLowerCase())})),e.value="",t.value="",i.value="",n.value="",s.value="",o.value="",r.value="",l.value="",a.value="",c.value="",m.value="",u.value="",d.value="",h.value="",n.value="",s.value="",p}render(){this.initUserInfo(),this.filter.updateFilterData(this.filmList),this.filmList.render()}initUserInfo(){localStorage.getItem("user")&&(userLogin.textContent=this.user.inputLogin,userLogin.classList.remove("invisible"),imgLogOut.classList.remove("invisible"),registrationForm.classList.add("invisible"),logIn.classList.add("invisible"))}registration(){const e={inputLogin:document.querySelector("#inputLogin").value,inputProfession:document.querySelector("#inputProfession").value};localStorage.setItem("user",JSON.stringify(e)),this.user=JSON.parse(localStorage.getItem("user"))}initEventListeners(){const e=document.querySelector("#logIn"),t=document.querySelector("#registrationForm"),i=document.querySelector("#btnRegistration"),n=document.querySelector("#imgLogOut"),s=document.querySelector("#userLogin");e.addEventListener("click",(()=>{t.classList.toggle("invisible")})),t.addEventListener("mouseleave",(()=>{t.classList.add("invisible")})),i.addEventListener("click",(()=>{this.registration(),this.initUserInfo()})),n.addEventListener("click",(()=>{localStorage.removeItem("user"),s.classList.add("invisible"),n.classList.add("invisible"),e.classList.remove("invisible")}));const o=document.querySelector("#btnShowForm"),r=document.querySelector("#btnShowFilms"),l=document.querySelector(".film-info"),a=document.querySelector(".add-film-form"),c=document.querySelector("#btnAddFilm");r.addEventListener("click",(()=>{l.style.display="none"})),o.addEventListener("click",(()=>{a.classList.toggle("invisible")})),c.addEventListener("click",(()=>{this.addFilm(),this.render()}));const m=document.querySelector("#filterCountry"),u=document.querySelector("#filterGenre"),d=document.querySelector("#filterDate");m.addEventListener("change",(e=>{this.filter.sortByCountry(this.filmList,e.target.value)})),u.addEventListener("change",(e=>{this.filter.sortByGenre(this.filmList,e.target.value)})),d.addEventListener("change",(e=>{this.filter.sortByNewest(this.filmList,e.target.value)}))}}(document.querySelector(".wrap"));i.initEventListeners(),i.render()})();